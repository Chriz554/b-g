name: Deploy Blue-Green

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # üîπ Paso 1: Guardar la clave privada en un archivo temporal
      - name: Save SSH private key
        run: |
          echo "${{ secrets.VM_KEY }}" > /tmp/vm_key
          chmod 600 /tmp/vm_key

      # üöÄ Paso 2: Test de conexi√≥n SSH
      - name: Test SSH Connection
        run: |
          ssh -i /tmp/vm_key -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@${{ secrets.VM_IP }} "echo 'SSH Connection Successful!'"

      # üì¶ Paso 3: Subir archivos a la VM
      - name: Upload files to VM
        run: |
          scp -i /tmp/vm_key -o StrictHostKeyChecking=no -r ./ ${{ secrets.VM_USER }}@${{ secrets.VM_IP }}:~/Blue-Green

      # ‚öôÔ∏è Paso 4: Ejecutar scripts de despliegue
      - name: Execute deploy script
        run: |
          ssh -i /tmp/vm_key -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@${{ secrets.VM_IP }} "cd ~/Blue-Green/scripts && bash deploy_green.sh && bash switch.sh green"
